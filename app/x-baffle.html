<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/firebase-element/firebase-auth.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-styles/paper-styles.html">
<link rel="import" href="bower_components/paper-styles/default-theme.html">
<link rel="import" href="bower_components/paper-styles/shadow.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/paper-styles/color.html">

<dom-module id="x-baffle">
  <style>
    :host {
      display: block;
      background-color: var(--paper-grey-100);
    }
  </style>
  <template>
    <firebase-auth
    redirect="true"
    id="firebaseLogin"
    user="{{user}}"
    status-known="{{statusKnown}}"
    location="https://book-club.firebaseio.com"
    provider="google"
    on-error="errorHandler"
    on-user-created="userSuccessHandler"
    on-password-changed="userSuccessHandler"
    on-password-reset="userSuccessHandler"
    on-user-removed="userSuccessHandler"></firebase-auth>
    <firebase-document
      location="https://book-club.firebaseio.com/baffle/users" data="{{users}}"
      log><firebase-document>
    <div>
      <div>
        <h3>Login status:</h3>
        <p>{{computeLoginStatus(statusKnown, user)}}</p>
      </div>
      
    <paper-button hidden$="{{computeLoginHidden(statusKnown, user)}}"
    on-click="login">
      <div>Log in</div>
      <iron-icon icon="account-circle"></iron-icon>
    </paper-button>
    <paper-button hidden$="{{computeLogoutHidden(statusKnown, user)}}"
    on-click="logout">
    <div>Log out</div>
      <iron-icon icon="account-circle"></iron-icon>
    </paper-button>

  </template>
  <script>
    Polymer({
      is: "x-baffle",
      properties: {
        provider: {
          type: String,
          value: 'anonymous'
        },
        message: {
          type: String,
          value: ''
        },
        email: {
          type: String,
          value: ''
        },
        password: {
          type: String,
          value: ''
        },
        user: {
          type: Object,
          value: null
        },
        statusKnown: {
          type: Boolean
        },
        authed: {
          type: Boolean,
          notify: true
        }
      },
      listeners: {
        'login': 'handleLogin'
      },

      handleLogin: function(e) {
        console.log("event is called!!")
        console.log(e);
        console.log(e.detail.user);
        var next = {};
        next[e.detail.user.uid] = {
          "uid": e.detail.user.uid, "email": e.detail.user.google.email
          };
        this.users = next;
        this.authed = true;
        console.log(this.authed);
      },

      login: function() {
        this.$.firebaseLogin.login({'scope':'email'});
      },
      logout: function() {
        this.authed = false;
        console.log(this.authed);
        this.$.firebaseLogin.logout();
      },
      errorHandler: function(e) {
        alert("Login failed!");
        this.message = 'Error: ' + e.detail.message;
      },
      computeLoginStatus: function(statusKnown, user) {
        if (statusKnown && user) {
          return 'Hello, ' + user.google.displayName;

        }
        if (statusKnown) {
          return 'Please sign in';
        }
        return 'Unknown (checking status...)';
      },
      computeLoginHidden: function(statusKnown, user) {
        this.computeLoginStatus(statusKnown, user);
        return !statusKnown || !!user;
      },
      computeLogoutHidden: function(statusKnown, user) {
        return !statusKnown || !user;
      },
      // ready: function() {
      //   this.counter = 0;
      // },
      



    });
  </script>
</dom-module>